name: "Enforce: No docker-compose Usage"

on:
  push:
    branches: [ main, '**' ]
  pull_request:
    branches: [ main ]

jobs:
  forbid-docker-compose:
    runs-on: ubuntu-latest
    name: Fail if any `docker-compose` command usage is introduced in changed files
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changed files and scan for `docker-compose` command usage
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          set -euo pipefail
          echo "Detecting changed files for this event ($GITHUB_EVENT_NAME)..."

          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            BASE_SHA=$(jq -r .pull_request.base.sha "$GITHUB_EVENT_PATH")
            echo "Fetching base sha ${BASE_SHA}..."
            git fetch origin ${BASE_SHA} --depth=1 || true
            CHANGED_FILES=$(git diff --name-only ${BASE_SHA} HEAD || true)
          else
            CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r ${GITHUB_SHA} || true)
          fi

          if [ -z "${CHANGED_FILES}" ]; then
            echo "No changed files detected; nothing to scan."; exit 0
          fi

          echo "Changed files:"; echo "${CHANGED_FILES}"

          # Only scan changed files for occurrences where docker-compose is used as a command (followed by space or colon)
          regex='docker-compose[[:space:]]|docker-compose:'
          violations=0

          IFS=$'\n'
          for file in $CHANGED_FILES; do
            # skip missing or binary files
            if [ ! -f "$file" ]; then
              continue
            fi
            if grep -IEn -E "$regex" "$file" >/tmp/matches.txt || true; then
              echo "Matches in $file:"; cat /tmp/matches.txt; violations=$((violations+1))
            fi
          done

          if [ $violations -gt 0 ]; then
            echo "\nERROR: Found $violations files with 'docker-compose' command usage. Replace with 'docker compose' or adjust scripts."
            exit 1
          fi
          echo "No command-style 'docker-compose' usages found in changed files."
